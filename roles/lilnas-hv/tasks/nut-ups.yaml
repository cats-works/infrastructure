- name: Install packages
  package: 
    name:
      - nut-server
      - nut-snmp
      - nut
      - nut-client
    state: present
- name: install nut.conf
  template:
    src: templates/ups/nut.conf.j2
    dest: /etc/nut/nut.conf
    mode: '0644'
    owner: root
    group: root
- name: install ups.conf
  template:
    src: templates/ups/ups.conf.j2
    dest: /etc/nut/ups.conf
    mode: '0644'
    owner: root
    group: root
- name: install upsd.conf
  template:
    src: templates/ups/upsd.conf.j2
    dest: /etc/nut/upsd.conf
    mode: '0644'
    owner: root
    group: root
- name: install upsd.users
  template:
    src: templates/ups/upsd.users.j2
    dest: /etc/nut/upsd.users
    mode: '0644'
    owner: root
    group: root

- name: install upsmon.conf
  template:
    src: templates/ups/upsmon.conf.j2
    dest: /etc/nut/upsmon.conf
    mode: '0644'
    owner: root
    group: root

- name: install upsmon-exec script
  copy:
    src: files/libexec/upsmon-exec.sh 
    dest: /usr/libexec/upsmon-exec.sh
    mode: '0755'
    owner: root
    group: root

- name: restart nut-server
  service:
    name: nut-server
    state: restarted
    enabled: yes

- name: restart nut-client
  service:
    name: nut-server
    state: restarted
    enabled: yes

- name: install librenms ups-nut script
  copy:
    src: files/bin/ups-nut.sh 
    dest: /etc/snmp/ups-nut.sh
    mode: '0755'
    owner: root
    group: root

- name: Append our rule to snmpd.conf
  lineinfile:
    path: /etc/snmp/snmpd.conf
    line: extend ups-nut /etc/snmp/ups-nut.sh
